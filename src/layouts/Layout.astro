---
/**
 * Base Layout Component
 * Provides the HTML structure and SEO configuration for all pages.
 * Includes performance optimizations and privacy-compliant analytics.
 *
 * @example
 * ```astro
 * <Layout
 *   title="Page Title"
 *   description="Page description for SEO"
 * >
 *   <main>Page content here</main>
 * </Layout>
 * ```
 */

// Import global styles including design system variables
import '../styles/globals.css';

import SEO from '../components/SEO.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import AnnouncementBar from '../components/AnnouncementBar.astro';
import GoogleAnalytics from '../components/GoogleAnalytics.astro';
import CookieConsent from '../components/CookieConsent.astro';
import PerformanceMonitor from '../components/PerformanceMonitor.astro';
import ExitIntentPopup from '../components/ExitIntentPopup.astro';
import type { SEOProps } from '../types/seo';
import { seoConfig } from '../config/seo.config';
import { ACTIVE_PALETTE_ID } from '../config/color-palette.config';

// Extend SEOProps but make title and description optional with defaults
interface Props extends Partial<SEOProps> {
  /** Page title (defaults to site name) */
  title?: string;
  /** Page description (defaults to site default description) */
  description?: string;
  /** Additional classes for the body element */
  bodyClass?: string;
  /** Disable analytics for this page */
  disableAnalytics?: boolean;
}

const {
  title = seoConfig.siteName,
  description = seoConfig.defaultDescription,
  bodyClass = '',
  lang = seoConfig.defaultLang,
  disableAnalytics = false,
  ...seoProps
} = Astro.props;
---

<!doctype html>
<html lang={lang}>
	<head>
		<!-- Charset must be within first 1024 bytes -->
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<!-- Dark Mode & Color Palette Initialization - Runs before render to prevent flash -->
		<script is:inline define:vars={{ defaultPalette: ACTIVE_PALETTE_ID }}>
			(function() {
				// Dark mode initialization
				const THEME_KEY = 'houston-theme';
				const storedTheme = localStorage.getItem(THEME_KEY);
				const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

				if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
					document.documentElement.setAttribute('data-theme', 'dark');
				}

				// Color palette initialization
				const PALETTE_KEY = 'retail-color-palette';
				const VALID_PALETTES = ['light-airy', 'bold-editorial', 'earthy-organic'];
				const storedPalette = localStorage.getItem(PALETTE_KEY);

				// Use stored palette if valid, otherwise use default from config
				const palette = storedPalette && VALID_PALETTES.includes(storedPalette)
					? storedPalette
					: defaultPalette;

				document.documentElement.setAttribute('data-palette', palette);
			})();
		</script>

		<!-- Preconnect to external resources for performance -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

		<!-- DNS prefetch for analytics (loaded conditionally) -->
		<link rel="dns-prefetch" href="https://www.googletagmanager.com" />

		<SEO
			title={title}
			description={description}
			{...seoProps}
		/>

		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

		<!-- Google Analytics 4 (consent-based) -->
		{!disableAnalytics && <GoogleAnalytics />}

		<!-- Slot for additional head content -->
		<slot name="head" />
	</head>
	<body class={bodyClass}>
		<!-- Accessibility Skip Links Navigation -->
		<nav class="skip-links" aria-label="Skip to sections">
			<ul class="skip-links__list">
				<li><a href="#main-content" class="skip-link">Skip to main content</a></li>
				<li><a href="#shop-filters" class="skip-link">Skip to filters</a></li>
				<li><a href="#products-grid" class="skip-link">Skip to products</a></li>
				<li><a href="#footer" class="skip-link">Skip to footer</a></li>
			</ul>
		</nav>
		<AnnouncementBar />
		<Header currentPath={Astro.url.pathname} />
		<div id="main-content">
			<slot />
		</div>
		<Footer />

		<!-- Cookie Consent Banner (GDPR/CCPA compliant) -->
		{!disableAnalytics && <CookieConsent />}

		<!-- Performance Monitoring (Core Web Vitals) -->
		{!disableAnalytics && <PerformanceMonitor />}

		<!-- Exit Intent Newsletter Popup -->
		<ExitIntentPopup />

		<!-- Scroll Reveal Animation Observer -->
		<script>
			// Initialize Intersection Observer for scroll-reveal animations
			function initScrollReveal() {
				const revealElements = document.querySelectorAll('.reveal');

				if (revealElements.length === 0) return;

				// Check if user prefers reduced motion
				const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

				if (prefersReducedMotion) {
					// If reduced motion is preferred, make all elements visible immediately
					revealElements.forEach(el => el.classList.add('reveal--visible'));
					return;
				}

				const observer = new IntersectionObserver(
					(entries) => {
						entries.forEach(entry => {
							if (entry.isIntersecting) {
								entry.target.classList.add('reveal--visible');
								// Unobserve after revealing (one-time animation)
								observer.unobserve(entry.target);
							}
						});
					},
					{
						root: null,
						rootMargin: '0px 0px -50px 0px',
						threshold: 0.1
					}
				);

				revealElements.forEach(el => observer.observe(el));
			}

			// Run on DOM ready
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initScrollReveal);
			} else {
				initScrollReveal();
			}

			// Re-run on Astro page transitions (View Transitions API)
			document.addEventListener('astro:page-load', initScrollReveal);
		</script>
	</body>
</html>

<style>
	html,
	body {
		width: 100%;
		height: 100%;
	}

	/* Sticky footer layout using flexbox */
	body {
		display: flex;
		flex-direction: column;
		min-height: 100vh;
	}

	#main-content {
		flex: 1 0 auto;
	}
</style>
