---
/**
 * EventCard Component
 * A card component for displaying event previews with featured image,
 * event type badge, date, time, location, and registration link.
 *
 * Features:
 * - Featured image with hover effect
 * - Event type badge with color coding
 * - Date and time display
 * - Location display
 * - Registration/ticket button
 * - Accessible and responsive design
 * - Dark mode support
 *
 * @example Basic usage
 * ```astro
 * <EventCard event={eventEntry} />
 * ```
 *
 * @example Featured variant
 * ```astro
 * <EventCard event={eventEntry} variant="featured" />
 * ```
 */

import type { EventCardProps } from '../types/events';
import { getEventTypeConfig } from '../config/events.config';
import { formatEventDate, formatEventTime, getEventStatus } from '../utils/events';

interface Props extends EventCardProps {}

const {
  event,
  variant = 'default',
  showType = true,
  showLocation = true,
  showTime = true,
  showRegistration = true,
  class: className = '',
} = Astro.props;

const { data, slug } = event;

// Get event type configuration
const typeConfig = getEventTypeConfig(data.eventType);

// Get event status
const status = getEventStatus(event);

// Format date and time
const formattedDate = formatEventDate(data.startDate, data.endDate);
const formattedTime = data.startTime ? formatEventTime(data.startTime, data.endTime) : null;

// Location string
const locationStr = data.address.venue
  ? `${data.address.venue}, ${data.address.city}, ${data.address.state}`
  : `${data.address.city}, ${data.address.state}`;

// Build CSS classes
const cardClasses = [
  'event-card',
  `event-card--${variant}`,
  status === 'ongoing' && 'event-card--ongoing',
  status === 'past' && 'event-card--past',
  status === 'cancelled' && 'event-card--cancelled',
  data.featured && 'event-card--featured',
  className,
].filter(Boolean).join(' ');

// Registration/ticket text
const ctaText = data.pricing?.isFree === false ? 'Get Tickets' : 'Register';
const ctaUrl = data.ticketUrl || data.registrationUrl;
---

<article class={cardClasses}>
  <!-- Image Container -->
  <a href={`/events/${slug}`} class="event-card__image-link" tabindex="-1" aria-hidden="true">
    <div class="event-card__image-container">
      {data.featuredImage ? (
        <img
          src={data.featuredImage.src}
          alt={data.featuredImage.alt}
          width={data.featuredImage.width || 600}
          height={data.featuredImage.height || 400}
          loading="lazy"
          decoding="async"
          class="event-card__image"
        />
      ) : (
        <div class="event-card__image-placeholder">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="event-card__placeholder-icon"
            aria-hidden="true"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
      )}

      {/* Event Type Badge */}
      {showType && (
        <span
          class="event-card__type-badge"
          style={`background-color: ${typeConfig.color}; color: ${typeConfig.textColor};`}
        >
          {typeConfig.shortLabel}
        </span>
      )}

      {/* Status Badge */}
      {status === 'ongoing' && (
        <span class="event-card__status-badge event-card__status-badge--ongoing">
          Happening Now
        </span>
      )}
      {status === 'cancelled' && (
        <span class="event-card__status-badge event-card__status-badge--cancelled">
          Cancelled
        </span>
      )}
    </div>
  </a>

  <!-- Content -->
  <div class="event-card__content">
    {/* Date */}
    <div class="event-card__date">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="event-card__icon"
        aria-hidden="true"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <time datetime={data.startDate.toISOString()}>
        {formattedDate}
      </time>
    </div>

    {/* Time */}
    {showTime && formattedTime && (
      <div class="event-card__time">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="event-card__icon"
          aria-hidden="true"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span>{formattedTime}</span>
      </div>
    )}

    {/* Title */}
    <h3 class="event-card__title">
      <a href={`/events/${slug}`} class="event-card__title-link">
        {data.title}
      </a>
    </h3>

    {/* Description */}
    <p class="event-card__description">{data.description}</p>

    {/* Location */}
    {showLocation && (
      <div class="event-card__location">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="event-card__icon"
          aria-hidden="true"
        >
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span>{locationStr}</span>
      </div>
    )}

    {/* Footer with Price and CTA */}
    <div class="event-card__footer">
      {/* Price */}
      <div class="event-card__price">
        {data.pricing?.isFree !== false ? (
          <span class="event-card__price-free">Free</span>
        ) : (
          <span class="event-card__price-amount">
            ${data.pricing.price}
            {data.pricing.priceDescription && (
              <span class="event-card__price-note">{data.pricing.priceDescription}</span>
            )}
          </span>
        )}
      </div>

      {/* Registration Button */}
      {showRegistration && ctaUrl && status !== 'past' && status !== 'cancelled' && (
        <a href={ctaUrl} class="event-card__cta" target="_blank" rel="noopener noreferrer">
          {ctaText}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="event-card__cta-icon"
            aria-hidden="true"
          >
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </a>
      )}

      {/* View Details for past events */}
      {status === 'past' && (
        <a href={`/events/${slug}`} class="event-card__cta event-card__cta--secondary">
          View Details
        </a>
      )}
    </div>
  </div>
</article>

<style>
  /* =================================================================
   * EVENT CARD COMPONENT STYLES
   * =================================================================
   * Uses design system variables from variables.css
   * Follows BEM naming convention for maintainability
   */

  .event-card {
    /* Layout */
    display: flex;
    flex-direction: column;
    height: 100%;

    /* Visual */
    background-color: var(--color-background-elevated);
    border-radius: var(--radius-lg);
    overflow: hidden;

    /* Animation */
    transition:
      box-shadow var(--duration-300) var(--ease-out),
      transform var(--duration-300) var(--ease-out);
  }

  .event-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .event-card--featured {
    box-shadow: var(--shadow-md);
  }

  .event-card--past {
    opacity: 0.7;
  }

  .event-card--cancelled {
    opacity: 0.6;
  }

  /* =================================================================
   * IMAGE CONTAINER
   * ================================================================= */
  .event-card__image-link {
    display: block;
    text-decoration: none;
  }

  .event-card__image-container {
    position: relative;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    background-color: var(--color-background-muted);
  }

  .event-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    transition: transform var(--duration-500) var(--ease-out);
  }

  .event-card:hover .event-card__image {
    transform: scale(1.05);
  }

  .event-card__image-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background-color: var(--color-background-muted);
    color: var(--color-text-tertiary);
  }

  .event-card__placeholder-icon {
    width: 48px;
    height: 48px;
    opacity: 0.5;
  }

  /* =================================================================
   * TYPE BADGE
   * ================================================================= */
  .event-card__type-badge {
    position: absolute;
    top: var(--spacing-3);
    left: var(--spacing-3);
    padding: var(--spacing-1) var(--spacing-2-5);
    font-family: var(--font-body);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    border-radius: var(--radius-sm);
  }

  /* =================================================================
   * STATUS BADGE
   * ================================================================= */
  .event-card__status-badge {
    position: absolute;
    top: var(--spacing-3);
    right: var(--spacing-3);
    padding: var(--spacing-1) var(--spacing-2-5);
    font-family: var(--font-body);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    border-radius: var(--radius-sm);
  }

  .event-card__status-badge--ongoing {
    background-color: var(--color-success);
    color: var(--color-text-inverse);
    animation: pulse 2s infinite;
  }

  .event-card__status-badge--cancelled {
    background-color: var(--color-error);
    color: var(--color-text-inverse);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* =================================================================
   * CONTENT AREA
   * ================================================================= */
  .event-card__content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
    padding: var(--spacing-5);
    flex: 1;
  }

  /* =================================================================
   * DATE & TIME
   * ================================================================= */
  .event-card__date,
  .event-card__time,
  .event-card__location {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-tertiary);
  }

  .event-card__date {
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
  }

  .event-card__icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  /* =================================================================
   * TITLE
   * ================================================================= */
  .event-card__title {
    margin: var(--spacing-1) 0 0;
    font-family: var(--font-heading);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    line-height: var(--line-height-snug);
    color: var(--color-text-primary);
  }

  .event-card__title-link {
    color: inherit;
    text-decoration: none;
    transition: color var(--duration-150) var(--ease-in-out);
  }

  .event-card__title-link:hover {
    color: var(--color-primary);
  }

  .event-card__title-link:focus-visible {
    outline: none;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* =================================================================
   * DESCRIPTION
   * ================================================================= */
  .event-card__description {
    margin: 0;
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);

    /* Limit to 2 lines */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* =================================================================
   * FOOTER
   * ================================================================= */
  .event-card__footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-3);
    margin-top: auto;
    padding-top: var(--spacing-4);
    border-top: 1px solid var(--color-border);
  }

  /* =================================================================
   * PRICE
   * ================================================================= */
  .event-card__price {
    font-family: var(--font-body);
  }

  .event-card__price-free {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-success);
  }

  .event-card__price-amount {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
  }

  .event-card__price-note {
    display: block;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-normal);
    color: var(--color-text-tertiary);
  }

  /* =================================================================
   * CTA BUTTON
   * ================================================================= */
  .event-card__cta {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-1);
    padding: var(--spacing-2) var(--spacing-4);
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-inverse);
    background-color: var(--color-primary);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition:
      background-color var(--duration-150) var(--ease-in-out),
      transform var(--duration-150) var(--ease-out);
  }

  .event-card__cta:hover {
    background-color: var(--color-primary-hover);
    transform: translateX(2px);
  }

  .event-card__cta:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  .event-card__cta--secondary {
    background-color: transparent;
    color: var(--color-primary);
    border: 1px solid var(--color-primary);
  }

  .event-card__cta--secondary:hover {
    background-color: var(--color-primary);
    color: var(--color-text-inverse);
  }

  .event-card__cta-icon {
    width: 14px;
    height: 14px;
  }

  /* =================================================================
   * VARIANT: FEATURED
   * ================================================================= */
  .event-card--featured .event-card__image-container {
    aspect-ratio: 16 / 9;
  }

  .event-card--featured .event-card__title {
    font-size: var(--font-size-xl);
  }

  .event-card--featured .event-card__description {
    -webkit-line-clamp: 3;
  }

  /* =================================================================
   * VARIANT: COMPACT
   * ================================================================= */
  .event-card--compact {
    flex-direction: row;
  }

  .event-card--compact .event-card__image-container {
    width: 140px;
    min-width: 140px;
    aspect-ratio: 1;
  }

  .event-card--compact .event-card__content {
    padding: var(--spacing-3);
  }

  .event-card--compact .event-card__title {
    font-size: var(--font-size-base);
  }

  .event-card--compact .event-card__description {
    display: none;
  }

  .event-card--compact .event-card__footer {
    padding-top: var(--spacing-2);
    border-top: none;
  }

  /* =================================================================
   * VARIANT: LIST
   * ================================================================= */
  .event-card--list {
    flex-direction: row;
    align-items: center;
    padding: var(--spacing-4);
    gap: var(--spacing-4);
  }

  .event-card--list .event-card__image-link {
    display: none;
  }

  .event-card--list .event-card__content {
    flex-direction: row;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing-4);
    padding: 0;
  }

  .event-card--list .event-card__title {
    flex: 1;
    min-width: 200px;
    margin: 0;
  }

  .event-card--list .event-card__description {
    display: none;
  }

  .event-card--list .event-card__footer {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  /* =================================================================
   * RESPONSIVE STYLES
   * ================================================================= */
  @media screen and (max-width: 767px) {
    .event-card__content {
      padding: var(--spacing-4);
    }

    .event-card__title {
      font-size: var(--font-size-base);
    }

    .event-card--featured .event-card__title {
      font-size: var(--font-size-lg);
    }

    .event-card--compact,
    .event-card--list {
      flex-direction: column;
    }

    .event-card--compact .event-card__image-container,
    .event-card--list .event-card__image-link {
      width: 100%;
      display: block;
    }

    .event-card--compact .event-card__image-container {
      aspect-ratio: 16 / 10;
    }

    .event-card--list .event-card__content {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  /* =================================================================
   * REDUCED MOTION
   * ================================================================= */
  @media (prefers-reduced-motion: reduce) {
    .event-card,
    .event-card__image,
    .event-card__title-link,
    .event-card__cta {
      transition: none;
    }

    .event-card:hover {
      transform: none;
    }

    .event-card:hover .event-card__image {
      transform: none;
    }

    .event-card__cta:hover {
      transform: none;
    }

    .event-card__status-badge--ongoing {
      animation: none;
    }
  }

  /* =================================================================
   * DARK MODE
   * ================================================================= */
  :global(html[data-theme="dark"]) .event-card {
    background-color: var(--color-background-elevated);
  }

  /* =================================================================
   * HIGH CONTRAST MODE
   * ================================================================= */
  @media (forced-colors: active) {
    .event-card {
      border: 2px solid currentColor;
    }

    .event-card__type-badge,
    .event-card__status-badge {
      border: 1px solid currentColor;
    }
  }

  /* =================================================================
   * PRINT STYLES
   * ================================================================= */
  @media print {
    .event-card {
      box-shadow: none;
      border: 1px solid var(--color-border);
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .event-card:hover {
      transform: none;
      box-shadow: none;
    }
  }
</style>
