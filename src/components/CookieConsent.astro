---
/**
 * Cookie Consent Banner Component
 *
 * GDPR/CCPA compliant cookie consent banner with granular controls.
 * Supports accept all, reject all, and custom preferences.
 *
 * @example
 * ```astro
 * <CookieConsent />
 * ```
 */

import { consentBannerConfig } from '../config/analytics.config';

interface Props {
  /** Override privacy policy URL */
  privacyPolicyUrl?: string;
  /** Override cookie policy URL */
  cookiePolicyUrl?: string;
  /** Override company name */
  companyName?: string;
}

const {
  privacyPolicyUrl = consentBannerConfig.privacyPolicyUrl,
  cookiePolicyUrl = consentBannerConfig.cookiePolicyUrl,
  companyName = consentBannerConfig.companyName,
} = Astro.props;
---

<!-- Cookie Consent Banner -->
<div
  id="cookie-consent-banner"
  class="cookie-consent"
  role="dialog"
  aria-modal="true"
  aria-labelledby="cookie-consent-title"
  aria-describedby="cookie-consent-description"
  hidden
>
  <div class="cookie-consent__container">
    <div class="cookie-consent__content">
      <h2 id="cookie-consent-title" class="cookie-consent__title">
        Cookie Preferences
      </h2>
      <p id="cookie-consent-description" class="cookie-consent__description">
        We use cookies to enhance your browsing experience, analyze site traffic, and personalize content.
        You can choose which cookies you're comfortable with below.
      </p>

      <!-- Cookie Categories -->
      <div class="cookie-consent__categories" id="cookie-categories">
        <!-- Necessary Cookies (Always enabled) -->
        <div class="cookie-category">
          <div class="cookie-category__header">
            <label class="cookie-category__label">
              <input
                type="checkbox"
                checked
                disabled
                aria-describedby="necessary-description"
              />
              <span class="cookie-category__checkbox cookie-category__checkbox--disabled"></span>
              <span class="cookie-category__name">Necessary</span>
              <span class="cookie-category__badge">Always Active</span>
            </label>
          </div>
          <p id="necessary-description" class="cookie-category__description">
            Essential cookies required for the website to function properly. These cannot be disabled.
          </p>
        </div>

        <!-- Analytics Cookies -->
        <div class="cookie-category">
          <div class="cookie-category__header">
            <label class="cookie-category__label">
              <input
                type="checkbox"
                id="consent-analytics"
                name="analytics"
                aria-describedby="analytics-description"
              />
              <span class="cookie-category__checkbox"></span>
              <span class="cookie-category__name">Analytics</span>
            </label>
          </div>
          <p id="analytics-description" class="cookie-category__description">
            Help us understand how visitors interact with our website by collecting anonymous usage data.
          </p>
        </div>

        <!-- Marketing Cookies -->
        <div class="cookie-category">
          <div class="cookie-category__header">
            <label class="cookie-category__label">
              <input
                type="checkbox"
                id="consent-marketing"
                name="marketing"
                aria-describedby="marketing-description"
              />
              <span class="cookie-category__checkbox"></span>
              <span class="cookie-category__name">Marketing</span>
            </label>
          </div>
          <p id="marketing-description" class="cookie-category__description">
            Used to deliver personalized advertisements and measure the effectiveness of ad campaigns.
          </p>
        </div>

        <!-- Preferences Cookies -->
        <div class="cookie-category">
          <div class="cookie-category__header">
            <label class="cookie-category__label">
              <input
                type="checkbox"
                id="consent-preferences"
                name="preferences"
                aria-describedby="preferences-description"
              />
              <span class="cookie-category__checkbox"></span>
              <span class="cookie-category__name">Preferences</span>
            </label>
          </div>
          <p id="preferences-description" class="cookie-category__description">
            Remember your settings and preferences for a more personalized experience.
          </p>
        </div>
      </div>

      <!-- Links -->
      <div class="cookie-consent__links">
        <a href={privacyPolicyUrl} class="cookie-consent__link">Privacy Policy</a>
        {cookiePolicyUrl && (
          <>
            <span class="cookie-consent__link-separator">|</span>
            <a href={cookiePolicyUrl} class="cookie-consent__link">Cookie Policy</a>
          </>
        )}
      </div>
    </div>

    <!-- Actions -->
    <div class="cookie-consent__actions">
      <button
        type="button"
        id="cookie-reject-all"
        class="cookie-consent__button cookie-consent__button--secondary"
      >
        Reject All
      </button>
      <button
        type="button"
        id="cookie-save-preferences"
        class="cookie-consent__button cookie-consent__button--secondary"
      >
        Save Preferences
      </button>
      <button
        type="button"
        id="cookie-accept-all"
        class="cookie-consent__button cookie-consent__button--primary"
      >
        Accept All
      </button>
    </div>
  </div>
</div>

<!-- Floating Cookie Settings Button (shown after consent) -->
<button
  type="button"
  id="cookie-settings-toggle"
  class="cookie-settings-toggle"
  aria-label="Open cookie settings"
  hidden
>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" aria-hidden="true">
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
  </svg>
</button>

<style>
  /* Cookie Consent Banner Styles */
  .cookie-consent {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: var(--z-modal, 9999);
    background: var(--color-background, #ffffff);
    border-top: 3px solid var(--color-primary, #365395);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15), 0 -8px 30px rgba(54, 83, 149, 0.1);
    transform: translateY(100%);
    transition: transform var(--duration-300, 300ms) var(--ease-out, ease-out);
  }

  /* Add a subtle backdrop overlay when banner is visible */
  .cookie-consent::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.15);
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--duration-300, 300ms) var(--ease-out, ease-out);
    z-index: -1;
  }

  .cookie-consent[data-visible="true"] {
    transform: translateY(0);
  }

  .cookie-consent[data-visible="true"]::before {
    opacity: 1;
  }

  .cookie-consent__container {
    max-width: var(--container-xl, 1280px);
    margin: 0 auto;
    padding: var(--spacing-6, 1.5rem);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4, 1rem);
    position: relative;
  }

  @media (min-width: 1024px) {
    .cookie-consent__container {
      flex-direction: row;
      align-items: flex-start;
      gap: var(--spacing-8, 2rem);
    }
  }

  .cookie-consent__content {
    flex: 1;
  }

  .cookie-consent__title {
    font-size: var(--font-size-lg, 1.125rem);
    font-weight: var(--font-weight-semibold, 600);
    color: var(--color-text-primary, #111827);
    margin-bottom: var(--spacing-2, 0.5rem);
  }

  .cookie-consent__description {
    font-size: var(--font-size-sm, 0.875rem);
    color: var(--color-text-secondary, #6b7280);
    line-height: var(--line-height-relaxed, 1.625);
    margin-bottom: var(--spacing-4, 1rem);
  }

  /* Cookie Categories */
  .cookie-consent__categories {
    display: none;
    flex-direction: column;
    gap: var(--spacing-3, 0.75rem);
    margin-bottom: var(--spacing-4, 1rem);
    padding: var(--spacing-4, 1rem);
    background: var(--color-background-muted, #f9fafb);
    border-radius: var(--radius-lg, 0.5rem);
  }

  .cookie-consent__categories[data-expanded="true"] {
    display: flex;
  }

  .cookie-category {
    padding-bottom: var(--spacing-3, 0.75rem);
    border-bottom: 1px solid var(--color-border-light, #e5e7eb);
  }

  .cookie-category:last-child {
    padding-bottom: 0;
    border-bottom: none;
  }

  .cookie-category__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .cookie-category__label {
    display: flex;
    align-items: center;
    gap: var(--spacing-2, 0.5rem);
    cursor: pointer;
    font-size: var(--font-size-sm, 0.875rem);
  }

  .cookie-category__label input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .cookie-category__checkbox {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-border, #d1d5db);
    border-radius: var(--radius-sm, 0.25rem);
    background: var(--color-background, #ffffff);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--duration-150, 150ms) var(--ease-in-out, ease-in-out);
    flex-shrink: 0;
  }

  .cookie-category__checkbox::after {
    content: '';
    width: 10px;
    height: 10px;
    background: var(--color-primary, #365395);
    border-radius: 2px;
    opacity: 0;
    transform: scale(0);
    transition: all var(--duration-150, 150ms) var(--ease-in-out, ease-in-out);
  }

  .cookie-category__label input:checked + .cookie-category__checkbox {
    border-color: var(--color-primary, #365395);
  }

  .cookie-category__label input:checked + .cookie-category__checkbox::after {
    opacity: 1;
    transform: scale(1);
  }

  .cookie-category__checkbox--disabled {
    background: var(--color-background-muted, #f3f4f6);
    border-color: var(--color-border-light, #e5e7eb);
  }

  .cookie-category__label input:disabled + .cookie-category__checkbox--disabled::after {
    opacity: 1;
    transform: scale(1);
    background: var(--color-text-tertiary, #9ca3af);
  }

  .cookie-category__name {
    font-weight: var(--font-weight-medium, 500);
    color: var(--color-text-primary, #111827);
  }

  .cookie-category__badge {
    font-size: var(--font-size-xs, 0.75rem);
    color: var(--color-text-tertiary, #9ca3af);
    background: var(--color-background, #ffffff);
    padding: var(--spacing-0-5, 0.125rem) var(--spacing-2, 0.5rem);
    border-radius: var(--radius-full, 9999px);
    margin-left: auto;
  }

  .cookie-category__description {
    font-size: var(--font-size-xs, 0.75rem);
    color: var(--color-text-tertiary, #6b7280);
    margin-top: var(--spacing-1, 0.25rem);
    padding-left: calc(18px + var(--spacing-2, 0.5rem));
  }

  /* Links */
  .cookie-consent__links {
    display: flex;
    gap: var(--spacing-2, 0.5rem);
    font-size: var(--font-size-xs, 0.75rem);
  }

  .cookie-consent__link {
    color: var(--color-primary, #365395);
    text-decoration: none;
  }

  .cookie-consent__link:hover {
    text-decoration: underline;
  }

  .cookie-consent__link-separator {
    color: var(--color-text-tertiary, #9ca3af);
  }

  /* Actions */
  .cookie-consent__actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2, 0.5rem);
    align-items: center;
  }

  @media (min-width: 1024px) {
    .cookie-consent__actions {
      flex-direction: column;
      flex-shrink: 0;
    }
  }

  .cookie-consent__button {
    padding: var(--spacing-2, 0.5rem) var(--spacing-4, 1rem);
    border-radius: var(--radius-md, 0.375rem);
    font-size: var(--font-size-sm, 0.875rem);
    font-weight: var(--font-weight-medium, 500);
    cursor: pointer;
    transition: all var(--duration-150, 150ms) var(--ease-in-out, ease-in-out);
    white-space: nowrap;
    min-width: 120px;
    text-align: center;
  }

  .cookie-consent__button--primary {
    background: var(--color-primary, #365395);
    color: var(--color-text-on-primary, #ffffff);
    border: 1px solid var(--color-primary, #365395);
  }

  .cookie-consent__button--primary:hover {
    background: var(--color-primary-600, #2d4680);
  }

  .cookie-consent__button--secondary {
    background: transparent;
    color: var(--color-text-secondary, #6b7280);
    border: 1px solid var(--color-border, #d1d5db);
  }

  .cookie-consent__button--secondary:hover {
    background: var(--color-background-muted, #f9fafb);
    color: var(--color-text-primary, #111827);
  }

  .cookie-consent__button:focus-visible {
    outline: 2px solid var(--color-primary, #365395);
    outline-offset: 2px;
  }

  /* Cookie Settings Toggle Button */
  .cookie-settings-toggle {
    position: fixed;
    bottom: var(--spacing-4, 1rem);
    left: var(--spacing-4, 1rem);
    z-index: var(--z-modal, 9998);
    width: 44px;
    height: 44px;
    border-radius: var(--radius-full, 9999px);
    background: var(--color-primary, #365395);
    color: var(--color-text-on-primary, #ffffff);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg, 0 10px 15px -3px rgba(0, 0, 0, 0.1));
    transition: all var(--duration-150, 150ms) var(--ease-in-out, ease-in-out);
  }

  .cookie-settings-toggle:hover {
    background: var(--color-primary-600, #2d4680);
    transform: scale(1.05);
  }

  .cookie-settings-toggle:focus-visible {
    outline: 2px solid var(--color-primary, #365395);
    outline-offset: 2px;
  }

  .cookie-settings-toggle[hidden] {
    display: none;
  }

  /* Animation for banner */
  @media (prefers-reduced-motion: reduce) {
    .cookie-consent {
      transition: none;
    }
  }
</style>

<script>
  import {
    loadGA4Script,
    getStoredConsent,
    acceptAllCookies,
    acceptNecessaryOnly,
    updateConsent,
    initAutoTracking,
    trackPageView,
    isAnalyticsEnabled,
  } from '../utils/analytics';
  import type { ConsentPreferences } from '../types/analytics';

  // DOM Elements
  const banner = document.getElementById('cookie-consent-banner') as HTMLElement;
  const categories = document.getElementById('cookie-categories') as HTMLElement;
  const settingsToggle = document.getElementById('cookie-settings-toggle') as HTMLButtonElement;

  const acceptAllBtn = document.getElementById('cookie-accept-all') as HTMLButtonElement;
  const rejectAllBtn = document.getElementById('cookie-reject-all') as HTMLButtonElement;
  const savePrefsBtn = document.getElementById('cookie-save-preferences') as HTMLButtonElement;

  const analyticsCheckbox = document.getElementById('consent-analytics') as HTMLInputElement;
  const marketingCheckbox = document.getElementById('consent-marketing') as HTMLInputElement;
  const preferencesCheckbox = document.getElementById('consent-preferences') as HTMLInputElement;

  /**
   * Show the consent banner
   */
  function showBanner(): void {
    banner.hidden = false;
    banner.setAttribute('data-visible', 'true');
    categories.setAttribute('data-expanded', 'true');
    settingsToggle.hidden = true;

    // Focus trap
    acceptAllBtn.focus();
  }

  /**
   * Hide the consent banner
   */
  function hideBanner(): void {
    banner.setAttribute('data-visible', 'false');

    // Wait for animation to complete
    setTimeout(() => {
      banner.hidden = true;
      settingsToggle.hidden = false;
    }, 300);
  }

  /**
   * Get current preferences from checkboxes
   */
  function getCurrentPreferences(): ConsentPreferences {
    return {
      necessary: true,
      analytics: analyticsCheckbox.checked,
      marketing: marketingCheckbox.checked,
      preferences: preferencesCheckbox.checked,
    };
  }

  /**
   * Set checkbox states from preferences
   */
  function setCheckboxStates(preferences: ConsentPreferences): void {
    analyticsCheckbox.checked = preferences.analytics;
    marketingCheckbox.checked = preferences.marketing;
    preferencesCheckbox.checked = preferences.preferences;
  }

  /**
   * Initialize consent banner
   */
  async function initConsentBanner(): Promise<void> {
    // Check for stored consent
    const storedConsent = getStoredConsent();

    if (storedConsent && storedConsent.hasConsented) {
      // User has already consented
      setCheckboxStates(storedConsent.preferences);
      settingsToggle.hidden = false;

      // Load GA4 if analytics is enabled
      if (storedConsent.preferences.analytics) {
        await loadGA4Script();
        initAutoTracking();
      }
    } else {
      // Show consent banner
      showBanner();
    }
  }

  // Event Listeners
  acceptAllBtn.addEventListener('click', async () => {
    // Set all checkboxes to checked
    analyticsCheckbox.checked = true;
    marketingCheckbox.checked = true;
    preferencesCheckbox.checked = true;

    // Load GA4 and accept all
    await loadGA4Script();
    acceptAllCookies();
    initAutoTracking();

    hideBanner();
  });

  rejectAllBtn.addEventListener('click', () => {
    // Set all checkboxes to unchecked
    analyticsCheckbox.checked = false;
    marketingCheckbox.checked = false;
    preferencesCheckbox.checked = false;

    acceptNecessaryOnly();
    hideBanner();
  });

  savePrefsBtn.addEventListener('click', async () => {
    const preferences = getCurrentPreferences();

    // Load GA4 if analytics is enabled
    if (preferences.analytics) {
      await loadGA4Script();
      initAutoTracking();
    }

    updateConsent(preferences);

    // Track page view if analytics is now enabled
    if (preferences.analytics && isAnalyticsEnabled()) {
      trackPageView();
    }

    hideBanner();
  });

  settingsToggle.addEventListener('click', () => {
    showBanner();
  });

  // Handle Escape key
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && !banner.hidden) {
      // Don't allow closing without making a choice
      acceptAllBtn.focus();
    }
  });

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initConsentBanner);

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initConsentBanner);
</script>
