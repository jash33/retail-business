---
/**
 * TestimonialCard Component
 * A card component for displaying a single customer testimonial with quote,
 * author info, photo, and star rating.
 *
 * Features:
 * - Customer quote display with quotation mark styling
 * - Author photo with fallback avatar
 * - Star rating display (1-5 stars)
 * - Verified review badge
 * - Role and company information
 * - Hover animations for interactivity
 * - Accessible with proper ARIA attributes
 *
 * @example Basic usage
 * ```astro
 * <TestimonialCard
 *   id="testimonial-1"
 *   content="Great service!"
 *   author="John Doe"
 *   rating={5}
 * />
 * ```
 *
 * @example With full details
 * ```astro
 * <TestimonialCard
 *   id="testimonial-1"
 *   content="The best web service I've ever used."
 *   author="Jane Smith"
 *   role="CEO"
 *   company="Tech Startup"
 *   image={{ src: "/avatar.jpg", alt: "Jane Smith" }}
 *   rating={5}
 *   verified={true}
 * />
 * ```
 */

import type { Testimonial } from '../types/testimonial';

interface Props extends Testimonial {
  /** Whether to show the star rating */
  showRating?: boolean;
  /** Whether to show the verified badge */
  showVerified?: boolean;
  /** Additional CSS class names */
  class?: string;
}

const {
  id,
  content,
  author,
  role,
  company,
  image,
  rating,
  verified = false,
  showRating = true,
  showVerified = true,
  class: className = '',
} = Astro.props;

// Build CSS classes
const cardClasses = [
  'testimonial-card',
  className,
].filter(Boolean).join(' ');

// Generate star rating icons
const starIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
const starEmptyIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>`;

// Quote icon
const quoteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></svg>`;

// Verified badge icon
const verifiedIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>`;

// Default avatar fallback
const defaultAvatar = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
---

<article class={cardClasses} id={`testimonial-${id}`}>
  <!-- Quote Icon -->
  <div class="testimonial-card__quote-icon" aria-hidden="true">
    <Fragment set:html={quoteIcon} />
  </div>

  <!-- Content -->
  <blockquote class="testimonial-card__content">
    <p class="testimonial-card__text">{content}</p>
  </blockquote>

  <!-- Star Rating -->
  {showRating && rating && (
    <div
      class="testimonial-card__rating"
      role="img"
      aria-label={`Rating: ${rating} out of 5 stars`}
    >
      {[1, 2, 3, 4, 5].map((star) => (
        <span
          class={`testimonial-card__star ${star <= rating ? 'testimonial-card__star--filled' : 'testimonial-card__star--empty'}`}
          set:html={star <= rating ? starIcon : starEmptyIcon}
        />
      ))}
    </div>
  )}

  <!-- Author Info -->
  <footer class="testimonial-card__author">
    <!-- Author Photo -->
    <div class="testimonial-card__avatar">
      {image ? (
        <img
          src={image.src}
          alt={image.alt || `Photo of ${author}`}
          width={image.width || 56}
          height={image.height || 56}
          loading="lazy"
          decoding="async"
        />
      ) : (
        <span class="testimonial-card__avatar-fallback" aria-hidden="true">
          <Fragment set:html={defaultAvatar} />
        </span>
      )}
    </div>

    <!-- Author Details -->
    <div class="testimonial-card__author-info">
      <cite class="testimonial-card__name">
        {author}
        {showVerified && verified && (
          <span class="testimonial-card__verified" title="Verified Review">
            <Fragment set:html={verifiedIcon} />
            <span class="sr-only">Verified Review</span>
          </span>
        )}
      </cite>
      {(role || company) && (
        <span class="testimonial-card__role">
          {role}{role && company && ', '}{company}
        </span>
      )}
    </div>
  </footer>
</article>

<style>
  /* =================================================================
   * TESTIMONIAL CARD COMPONENT STYLES
   * =================================================================
   * Uses design system variables from variables.css
   * Follows BEM naming convention for maintainability
   */

  .testimonial-card {
    /* Layout */
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);

    /* Box model */
    padding: var(--spacing-6);
    height: 100%;

    /* Positioning for pseudo-elements */
    position: relative;

    /* Visual */
    background-color: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);

    /* Overflow for shine effect */
    overflow: hidden;

    /* Animation */
    transition:
      box-shadow var(--duration-300) var(--ease-out),
      transform var(--duration-300) var(--ease-out),
      border-color var(--duration-300) var(--ease-out);
  }

  /* Shine sweep effect - diagonal sweep across card on hover */
  .testimonial-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.1) 50%,
      transparent 100%
    );
    transform: skewX(-20deg);
    transition: left var(--duration-700) var(--ease-out);
    pointer-events: none;
    z-index: 1;
  }

  .testimonial-card:hover {
    box-shadow: var(--shadow-lg), var(--glow-card-hover);
    transform: translateY(-4px);
    border-color: var(--color-primary-300);
  }

  .testimonial-card:hover::after {
    left: 150%;
  }

  /* =================================================================
   * QUOTE ICON
   * ================================================================= */
  .testimonial-card__quote-icon {
    position: absolute;
    top: var(--spacing-4);
    right: var(--spacing-4);
    width: var(--spacing-10);
    height: var(--spacing-10);
    color: var(--color-primary-200);
    opacity: 0.5;
    z-index: 0;
    transition: opacity var(--duration-200) var(--ease-out);
  }

  .testimonial-card:hover .testimonial-card__quote-icon {
    opacity: 0.8;
    color: var(--color-primary-300);
  }

  .testimonial-card__quote-icon :global(svg) {
    width: 100%;
    height: 100%;
  }

  /* =================================================================
   * CONTENT / QUOTE
   * ================================================================= */
  .testimonial-card__content {
    margin: 0;
    padding: 0;
    flex: 1;
    position: relative;
    z-index: 2;
  }

  .testimonial-card__text {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    color: var(--color-text-primary);
    line-height: var(--line-height-relaxed);
    margin: 0;
    font-style: italic;
  }

  /* =================================================================
   * STAR RATING
   * ================================================================= */
  .testimonial-card__rating {
    display: flex;
    gap: var(--spacing-1);
    position: relative;
    z-index: 2;
  }

  .testimonial-card__star {
    display: inline-flex;
    width: var(--spacing-5);
    height: var(--spacing-5);
    transition: transform var(--duration-150) var(--ease-out);
  }

  .testimonial-card__star :global(svg) {
    width: 100%;
    height: 100%;
  }

  .testimonial-card__star--filled {
    color: var(--color-warning, #F59E0B);
  }

  .testimonial-card__star--empty {
    color: var(--color-border-dark);
  }

  .testimonial-card:hover .testimonial-card__star--filled {
    animation: star-pulse 0.3s var(--ease-out);
  }

  .testimonial-card:hover .testimonial-card__star--filled:nth-child(1) { animation-delay: 0ms; }
  .testimonial-card:hover .testimonial-card__star--filled:nth-child(2) { animation-delay: 50ms; }
  .testimonial-card:hover .testimonial-card__star--filled:nth-child(3) { animation-delay: 100ms; }
  .testimonial-card:hover .testimonial-card__star--filled:nth-child(4) { animation-delay: 150ms; }
  .testimonial-card:hover .testimonial-card__star--filled:nth-child(5) { animation-delay: 200ms; }

  @keyframes star-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* =================================================================
   * AUTHOR SECTION
   * ================================================================= */
  .testimonial-card__author {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    position: relative;
    z-index: 2;
    padding-top: var(--spacing-4);
    border-top: 1px solid var(--color-border);
    margin-top: auto;
  }

  /* Avatar */
  .testimonial-card__avatar {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    border-radius: var(--radius-full);
    overflow: hidden;
    background-color: var(--color-background-muted);
    border: 2px solid var(--color-border);
    transition: border-color var(--duration-200) var(--ease-out);
  }

  .testimonial-card:hover .testimonial-card__avatar {
    border-color: var(--color-primary-300);
  }

  .testimonial-card__avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .testimonial-card__avatar-fallback {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    color: var(--color-text-tertiary);
  }

  .testimonial-card__avatar-fallback :global(svg) {
    width: 32px;
    height: 32px;
  }

  /* Author Info */
  .testimonial-card__author-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-1);
    min-width: 0;
  }

  .testimonial-card__name {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    font-style: normal;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .testimonial-card__verified {
    display: inline-flex;
    width: var(--spacing-5);
    height: var(--spacing-5);
    color: var(--color-success, #22C55E);
  }

  .testimonial-card__verified :global(svg) {
    width: 100%;
    height: 100%;
  }

  .testimonial-card__role {
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-snug);
  }

  /* =================================================================
   * SCREEN READER ONLY TEXT
   * ================================================================= */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* =================================================================
   * RESPONSIVE STYLES
   * ================================================================= */

  /* Tablet and up (768px) */
  @media screen and (min-width: 768px) {
    .testimonial-card {
      padding: var(--spacing-8);
      gap: var(--spacing-5);
    }

    .testimonial-card__text {
      font-size: var(--font-size-lg);
    }

    .testimonial-card__quote-icon {
      width: var(--spacing-12);
      height: var(--spacing-12);
    }
  }

  /* =================================================================
   * REDUCED MOTION
   * Respect user preferences for reduced motion
   * ================================================================= */
  @media (prefers-reduced-motion: reduce) {
    .testimonial-card,
    .testimonial-card__quote-icon,
    .testimonial-card__avatar,
    .testimonial-card__star {
      transition: none;
    }

    .testimonial-card::after {
      display: none;
    }

    .testimonial-card:hover {
      transform: none;
      box-shadow: var(--shadow-lg);
    }

    .testimonial-card:hover .testimonial-card__star--filled {
      animation: none;
    }
  }

  /* =================================================================
   * DARK MODE
   * ================================================================= */
  :global(html[data-theme="dark"]) .testimonial-card {
    background-color: var(--color-background-elevated);
    border-color: var(--color-border);
  }

  :global(html[data-theme="dark"]) .testimonial-card:hover {
    border-color: var(--color-primary-400);
  }

  :global(html[data-theme="dark"]) .testimonial-card__quote-icon {
    color: var(--color-primary-400);
  }

  :global(html[data-theme="dark"]) .testimonial-card__star--empty {
    color: var(--color-border);
  }

  /* =================================================================
   * HIGH CONTRAST MODE
   * Windows High Contrast support
   * ================================================================= */
  @media (forced-colors: active) {
    .testimonial-card {
      border: 2px solid CanvasText;
    }

    .testimonial-card__avatar {
      border: 2px solid CanvasText;
    }

    .testimonial-card__author {
      border-top: 1px solid CanvasText;
    }

    .testimonial-card__star--filled,
    .testimonial-card__verified {
      color: Highlight;
    }
  }

  /* =================================================================
   * PRINT STYLES
   * ================================================================= */
  @media print {
    .testimonial-card {
      box-shadow: none;
      border: 1px solid var(--color-border);
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .testimonial-card:hover {
      transform: none;
      box-shadow: none;
    }

    .testimonial-card__quote-icon {
      opacity: 0.3;
    }
  }
</style>
