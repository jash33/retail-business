---
/**
 * FAQ Accordion Component
 * A fully accessible accordion component for displaying frequently asked questions.
 *
 * Features:
 * - WCAG 2.1 AA compliant accessibility
 * - Full keyboard navigation (Tab, Enter, Space, Arrow keys)
 * - Proper ARIA attributes (aria-expanded, aria-controls, aria-labelledby, role="region")
 * - Smooth expand/collapse animations with reduced motion support
 * - Single or multiple panels open simultaneously
 * - Focus management when expanding/collapsing
 * - Responsive design for mobile, tablet, and desktop
 * - Visual indicators for expanded/collapsed states
 * - Screen reader friendly announcements
 *
 * @example Basic usage
 * ```astro
 * <FAQAccordion items={faqItems} />
 * ```
 *
 * @example With heading and multiple panels
 * ```astro
 * <FAQAccordion
 *   items={faqItems}
 *   heading="Frequently Asked Questions"
 *   subheading="Find answers to common questions about our services."
 *   allowMultiple={true}
 *   initialExpanded={0}
 * />
 * ```
 */

import type { FAQAccordionProps, FAQItem } from '../types/faq';

interface Props extends FAQAccordionProps {}

const {
  items,
  heading = 'Frequently Asked Questions',
  subheading,
  allowMultiple = false,
  initialExpanded = null,
  id = 'faq',
  class: className = '',
} = Astro.props;

// Generate unique IDs for each FAQ item for ARIA relationships
const generateIds = (item: FAQItem, index: number) => ({
  triggerId: `${id}-trigger-${index}`,
  panelId: `${id}-panel-${index}`,
  isInitiallyExpanded: initialExpanded === index,
});

const faqItemsWithIds = items.map((item, index) => ({
  ...item,
  ...generateIds(item, index),
}));

// Build CSS classes
const sectionClasses = [
  'faq-section',
  className,
].filter(Boolean).join(' ');
---

<section
  class={sectionClasses}
  id={id}
  aria-labelledby={`${id}-heading`}
>
  <div class="faq-container">
    <!-- Section Header -->
    <header class="faq-header">
      <h2 id={`${id}-heading`} class="faq-title">{heading}</h2>
      {subheading && (
        <p class="faq-description">{subheading}</p>
      )}
    </header>

    <!-- Accordion -->
    <div
      class="faq-accordion"
      role="presentation"
      data-allow-multiple={allowMultiple.toString()}
    >
      {faqItemsWithIds.map((item, index) => (
        <div
          class="faq-item"
          data-expanded={item.isInitiallyExpanded.toString()}
        >
          <!-- Accordion Header/Trigger -->
          <h3 class="faq-item__heading">
            <button
              type="button"
              class="faq-item__trigger"
              id={item.triggerId}
              aria-expanded={item.isInitiallyExpanded.toString()}
              aria-controls={item.panelId}
            >
              <span class="faq-item__question">{item.question}</span>
              <span class="faq-item__icon" aria-hidden="true">
                <svg
                  class="faq-item__icon-svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </span>
            </button>
          </h3>

          <!-- Accordion Panel/Content -->
          <div
            id={item.panelId}
            class="faq-item__panel"
            role="region"
            aria-labelledby={item.triggerId}
            hidden={!item.isInitiallyExpanded}
          >
            <div class="faq-item__content" set:html={item.answer} />
          </div>
        </div>
      ))}
    </div>

    <!-- Screen reader announcement region -->
    <div
      class="sr-only"
      role="status"
      aria-live="polite"
      aria-atomic="true"
      id={`${id}-announcer`}
    ></div>
  </div>
</section>

<style>
  /* =================================================================
   * FAQ SECTION
   * ================================================================= */
  .faq-section {
    padding: var(--spacing-16) var(--spacing-4);
    background-color: var(--color-background-subtle);
  }

  .faq-container {
    max-width: var(--container-4xl);
    margin: 0 auto;
  }

  /* =================================================================
   * HEADER
   * ================================================================= */
  .faq-header {
    text-align: center;
    margin-bottom: var(--spacing-12);
  }

  .faq-title {
    font-family: var(--font-heading);
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin: 0 0 var(--spacing-4);
    line-height: var(--line-height-tight);
  }

  .faq-description {
    font-size: var(--font-size-md);
    color: var(--color-text-secondary);
    max-width: 40rem;
    margin: 0 auto;
    line-height: var(--line-height-relaxed);
  }

  /* =================================================================
   * ACCORDION CONTAINER
   * ================================================================= */
  .faq-accordion {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  /* =================================================================
   * FAQ ITEM
   * ================================================================= */
  .faq-item {
    background-color: var(--color-background);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: box-shadow var(--duration-200) var(--ease-in-out);
  }

  .faq-item:hover {
    box-shadow: var(--shadow-md);
  }

  .faq-item[data-expanded="true"] {
    box-shadow: var(--shadow-md);
  }

  /* =================================================================
   * FAQ ITEM HEADING (H3 wrapper)
   * ================================================================= */
  .faq-item__heading {
    margin: 0;
    font-size: inherit;
    font-weight: inherit;
    line-height: inherit;
  }

  /* =================================================================
   * FAQ TRIGGER BUTTON
   * ================================================================= */
  .faq-item__trigger {
    /* Reset */
    appearance: none;
    border: none;
    background: none;
    font: inherit;
    text-align: left;

    /* Layout */
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-4);
    width: 100%;
    padding: var(--spacing-5) var(--spacing-6);

    /* Typography */
    font-family: var(--font-heading);
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    line-height: var(--line-height-snug);

    /* Interaction */
    cursor: pointer;

    /* Transition */
    transition:
      background-color var(--duration-150) var(--ease-in-out),
      color var(--duration-150) var(--ease-in-out);
  }

  .faq-item__trigger:hover {
    background-color: var(--color-background-subtle);
    color: var(--color-primary);
  }

  /* Focus styles - WCAG 2.1 AA compliant */
  .faq-item__trigger:focus-visible {
    outline: none;
    box-shadow:
      inset 0 0 0 var(--focus-ring-width) var(--focus-ring-color);
    background-color: var(--color-primary-50);
  }

  /* Remove focus styles for mouse users */
  .faq-item__trigger:focus:not(:focus-visible) {
    outline: none;
    box-shadow: none;
  }

  /* Expanded state */
  .faq-item__trigger[aria-expanded="true"] {
    background-color: var(--color-primary-50);
    color: var(--color-primary);
  }

  /* =================================================================
   * QUESTION TEXT
   * ================================================================= */
  .faq-item__question {
    flex: 1;
    padding-right: var(--spacing-2);
  }

  /* =================================================================
   * ICON
   * ================================================================= */
  .faq-item__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    color: var(--color-primary);
    transition: transform var(--duration-300) var(--ease-in-out);
  }

  .faq-item__icon-svg {
    width: 100%;
    height: 100%;
  }

  /* Rotate icon when expanded */
  .faq-item__trigger[aria-expanded="true"] .faq-item__icon {
    transform: rotate(180deg);
  }

  /* =================================================================
   * PANEL (Collapsible content)
   * ================================================================= */
  .faq-item__panel {
    overflow: hidden;
    transition:
      max-height var(--duration-300) var(--ease-in-out),
      opacity var(--duration-200) var(--ease-in-out);
  }

  .faq-item__panel[hidden] {
    display: block;
    max-height: 0;
    opacity: 0;
    visibility: hidden;
  }

  .faq-item__panel:not([hidden]) {
    max-height: 500px; /* Will be set dynamically via JS */
    opacity: 1;
    visibility: visible;
  }

  /* =================================================================
   * CONTENT
   * ================================================================= */
  .faq-item__content {
    padding: var(--spacing-4) var(--spacing-6) var(--spacing-6);
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
  }

  /* Style inline HTML content */
  .faq-item__content :global(p) {
    margin: 0;
  }

  .faq-item__content :global(p + p) {
    margin-top: var(--spacing-4);
  }

  .faq-item__content :global(strong) {
    color: var(--color-text-primary);
    font-weight: var(--font-weight-semibold);
  }

  .faq-item__content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 0.2em;
  }

  .faq-item__content :global(a:hover) {
    color: var(--color-primary-hover);
  }

  .faq-item__content :global(ul),
  .faq-item__content :global(ol) {
    margin: var(--spacing-3) 0;
    padding-left: var(--spacing-6);
  }

  .faq-item__content :global(li) {
    margin-bottom: var(--spacing-2);
  }

  /* =================================================================
   * SCREEN READER ONLY
   * ================================================================= */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* =================================================================
   * RESPONSIVE STYLES
   * ================================================================= */
  @media (max-width: 768px) {
    .faq-section {
      padding: var(--spacing-12) var(--spacing-4);
    }

    .faq-title {
      font-size: var(--font-size-3xl);
    }

    .faq-header {
      margin-bottom: var(--spacing-8);
    }

    .faq-item__trigger {
      padding: var(--spacing-4) var(--spacing-4);
      font-size: var(--font-size-base);
    }

    .faq-item__content {
      padding: var(--spacing-3) var(--spacing-4) var(--spacing-4);
      font-size: var(--font-size-sm);
    }

    /* Larger touch targets on mobile */
    .faq-item__icon {
      width: 2rem;
      height: 2rem;
    }
  }

  @media (min-width: 1024px) {
    .faq-title {
      font-size: var(--font-size-5xl);
    }

    .faq-item__trigger {
      padding: var(--spacing-6) var(--spacing-8);
      font-size: var(--font-size-lg);
    }

    .faq-item__content {
      padding: var(--spacing-4) var(--spacing-8) var(--spacing-8);
    }
  }

  /* =================================================================
   * REDUCED MOTION
   * ================================================================= */
  @media (prefers-reduced-motion: reduce) {
    .faq-item,
    .faq-item__trigger,
    .faq-item__icon,
    .faq-item__panel {
      transition: none;
    }

    .faq-item__trigger[aria-expanded="true"] .faq-item__icon {
      transform: rotate(180deg);
    }
  }

  /* =================================================================
   * HIGH CONTRAST MODE
   * ================================================================= */
  @media (forced-colors: active) {
    .faq-item {
      border: 2px solid CanvasText;
    }

    .faq-item__trigger:focus-visible {
      outline: 3px solid Highlight;
      outline-offset: -3px;
    }

    .faq-item__trigger[aria-expanded="true"] {
      background-color: Highlight;
      color: HighlightText;
    }
  }

  /* =================================================================
   * PRINT STYLES
   * ================================================================= */
  @media print {
    .faq-section {
      padding: var(--spacing-8) 0;
      background: none;
    }

    .faq-item {
      box-shadow: none;
      border: 1px solid var(--color-border);
      page-break-inside: avoid;
    }

    .faq-item__panel[hidden] {
      display: block !important;
      max-height: none !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    .faq-item__icon {
      display: none;
    }
  }
</style>

<script>
  /**
   * FAQ Accordion Client-Side Logic
   * Handles expand/collapse functionality, keyboard navigation, and accessibility
   */

  interface AccordionState {
    allowMultiple: boolean;
    items: HTMLElement[];
    triggers: HTMLButtonElement[];
    panels: HTMLElement[];
    announcer: HTMLElement | null;
  }

  class FAQAccordion {
    private container: HTMLElement;
    private state: AccordionState;

    constructor(container: HTMLElement) {
      this.container = container;
      this.state = this.initializeState();
      this.bindEvents();
      this.initializePanelHeights();
    }

    private initializeState(): AccordionState {
      const accordion = this.container.querySelector('.faq-accordion') as HTMLElement;
      const items = Array.from(this.container.querySelectorAll('.faq-item')) as HTMLElement[];
      const triggers = Array.from(this.container.querySelectorAll('.faq-item__trigger')) as HTMLButtonElement[];
      const panels = Array.from(this.container.querySelectorAll('.faq-item__panel')) as HTMLElement[];
      const announcer = this.container.querySelector('[role="status"]') as HTMLElement;

      return {
        allowMultiple: accordion?.dataset.allowMultiple === 'true',
        items,
        triggers,
        panels,
        announcer,
      };
    }

    private bindEvents(): void {
      // Bind click events to triggers
      this.state.triggers.forEach((trigger, index) => {
        trigger.addEventListener('click', () => this.toggleItem(index));
      });

      // Bind keyboard events to triggers
      this.state.triggers.forEach((trigger, index) => {
        trigger.addEventListener('keydown', (event) => this.handleKeydown(event, index));
      });
    }

    private initializePanelHeights(): void {
      // Calculate and set max-height for smooth animations
      this.state.panels.forEach((panel) => {
        const content = panel.querySelector('.faq-item__content') as HTMLElement;
        if (content && !panel.hidden) {
          panel.style.maxHeight = `${content.scrollHeight + 32}px`;
        }
      });
    }

    private toggleItem(index: number): void {
      const trigger = this.state.triggers[index];
      const panel = this.state.panels[index];
      const item = this.state.items[index];

      if (!trigger || !panel || !item) return;

      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
      const newExpandedState = !isExpanded;

      // If not allowing multiple, close other panels first
      if (!this.state.allowMultiple && newExpandedState) {
        this.closeAllPanels();
      }

      // Toggle the clicked panel
      this.setPanelState(index, newExpandedState);

      // Announce state change to screen readers
      this.announceStateChange(index, newExpandedState);
    }

    private setPanelState(index: number, expanded: boolean): void {
      const trigger = this.state.triggers[index];
      const panel = this.state.panels[index];
      const item = this.state.items[index];
      const content = panel?.querySelector('.faq-item__content') as HTMLElement;

      if (!trigger || !panel || !item) return;

      // Update ARIA state
      trigger.setAttribute('aria-expanded', expanded.toString());
      item.setAttribute('data-expanded', expanded.toString());

      if (expanded) {
        // Expand panel
        panel.hidden = false;
        // Calculate actual content height for animation
        if (content) {
          panel.style.maxHeight = `${content.scrollHeight + 32}px`;
        }
      } else {
        // Collapse panel
        panel.style.maxHeight = '0px';
        // Use transitionend to set hidden after animation completes
        const handleTransitionEnd = () => {
          if (trigger.getAttribute('aria-expanded') === 'false') {
            panel.hidden = true;
          }
          panel.removeEventListener('transitionend', handleTransitionEnd);
        };
        panel.addEventListener('transitionend', handleTransitionEnd);
      }
    }

    private closeAllPanels(): void {
      this.state.triggers.forEach((_, index) => {
        const trigger = this.state.triggers[index];
        if (trigger?.getAttribute('aria-expanded') === 'true') {
          this.setPanelState(index, false);
        }
      });
    }

    private handleKeydown(event: KeyboardEvent, currentIndex: number): void {
      const { key } = event;

      switch (key) {
        case 'Enter':
        case ' ':
        case 'Spacebar':
          // Toggle current item
          event.preventDefault();
          this.toggleItem(currentIndex);
          break;

        case 'ArrowDown':
        case 'Down':
          // Move focus to next trigger
          event.preventDefault();
          this.focusItem(currentIndex + 1);
          break;

        case 'ArrowUp':
        case 'Up':
          // Move focus to previous trigger
          event.preventDefault();
          this.focusItem(currentIndex - 1);
          break;

        case 'Home':
          // Move focus to first trigger
          event.preventDefault();
          this.focusItem(0);
          break;

        case 'End':
          // Move focus to last trigger
          event.preventDefault();
          this.focusItem(this.state.triggers.length - 1);
          break;

        default:
          break;
      }
    }

    private focusItem(index: number): void {
      const totalItems = this.state.triggers.length;

      // Wrap around if needed
      let targetIndex = index;
      if (targetIndex < 0) {
        targetIndex = totalItems - 1;
      } else if (targetIndex >= totalItems) {
        targetIndex = 0;
      }

      const targetTrigger = this.state.triggers[targetIndex];
      targetTrigger?.focus();
    }

    private announceStateChange(index: number, expanded: boolean): void {
      if (!this.state.announcer) return;

      const trigger = this.state.triggers[index];
      const question = trigger?.querySelector('.faq-item__question')?.textContent || '';
      const action = expanded ? 'expanded' : 'collapsed';

      // Clear and set new announcement
      this.state.announcer.textContent = '';
      requestAnimationFrame(() => {
        if (this.state.announcer) {
          this.state.announcer.textContent = `${question.substring(0, 50)}... ${action}`;
        }
      });
    }
  }

  // Initialize all FAQ accordions on the page
  function initFAQAccordions(): void {
    const faqSections = document.querySelectorAll('.faq-section');
    faqSections.forEach((section) => {
      new FAQAccordion(section as HTMLElement);
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFAQAccordions);
  } else {
    initFAQAccordions();
  }

  // Re-initialize on Astro page transitions (for View Transitions)
  document.addEventListener('astro:page-load', initFAQAccordions);
</script>
