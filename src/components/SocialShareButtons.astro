---
/**
 * Social Share Buttons Component
 * Provides sharing functionality for articles to major social platforms.
 *
 * Features:
 * - Share to Twitter/X, Facebook, LinkedIn, Pinterest, Email
 * - Copy link to clipboard functionality
 * - Accessible buttons with screen reader text
 * - Responsive design
 * - Dark mode support
 * - No external dependencies (pure URL-based sharing)
 *
 * @example
 * ```astro
 * <SocialShareButtons
 *   url={Astro.url.href}
 *   title="My Article Title"
 *   description="Article description for sharing"
 *   image="/path/to/image.jpg"
 * />
 * ```
 */

interface Props {
  /** The URL to share */
  url: string;
  /** The title of the content being shared */
  title: string;
  /** Description/excerpt for platforms that support it */
  description?: string;
  /** Image URL for Pinterest sharing */
  image?: string;
  /** Optional via/username for Twitter */
  twitterVia?: string;
  /** Layout variant */
  variant?: 'horizontal' | 'vertical';
  /** Whether to show labels */
  showLabels?: boolean;
  /** Additional CSS class */
  class?: string;
  /** Content type for analytics tracking (e.g., 'article', 'product') */
  contentType?: 'article' | 'product' | 'page';
  /** Content ID for analytics tracking (e.g., slug) */
  contentId?: string;
}

const {
  url,
  title,
  description = '',
  image = '',
  twitterVia = '',
  variant = 'horizontal',
  showLabels = false,
  class: className = '',
  contentType = 'page',
  contentId = '',
} = Astro.props;

// Encode values for URL parameters
const encodedUrl = encodeURIComponent(url);
const encodedTitle = encodeURIComponent(title);
const encodedDescription = encodeURIComponent(description);
const encodedImage = encodeURIComponent(image);

// Generate share URLs
const shareUrls = {
  twitter: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}${twitterVia ? `&via=${twitterVia}` : ''}`,
  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
  linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
  pinterest: `https://pinterest.com/pin/create/button/?url=${encodedUrl}&media=${encodedImage}&description=${encodedTitle}`,
  email: `mailto:?subject=${encodedTitle}&body=${encodedDescription}%0A%0A${encodedUrl}`,
};

// Share button configuration
const shareButtons = [
  {
    name: 'Twitter',
    label: 'Share on X',
    url: shareUrls.twitter,
    icon: 'twitter',
    color: '#1DA1F2',
  },
  {
    name: 'Facebook',
    label: 'Share on Facebook',
    url: shareUrls.facebook,
    icon: 'facebook',
    color: '#1877F2',
  },
  {
    name: 'LinkedIn',
    label: 'Share on LinkedIn',
    url: shareUrls.linkedin,
    icon: 'linkedin',
    color: '#0A66C2',
  },
  {
    name: 'Pinterest',
    label: 'Pin on Pinterest',
    url: shareUrls.pinterest,
    icon: 'pinterest',
    color: '#E60023',
    requiresImage: true,
  },
  {
    name: 'Email',
    label: 'Share via Email',
    url: shareUrls.email,
    icon: 'email',
    color: '#6B7280',
    isEmail: true,
  },
];

// Filter Pinterest if no image
const visibleButtons = shareButtons.filter(
  (btn) => !btn.requiresImage || image
);
---

<div
  class:list={[
    'social-share',
    `social-share--${variant}`,
    { 'social-share--with-labels': showLabels },
    className,
  ]}
  role="group"
  aria-label="Share this content"
  data-content-type={contentType}
  data-content-id={contentId}
  data-content-title={title}
>
  <span class="social-share__label">Share:</span>

  <div class="social-share__buttons">
    {visibleButtons.map((button) => (
      <a
        href={button.url}
        class={`social-share__button social-share__button--${button.icon}`}
        target={button.isEmail ? undefined : '_blank'}
        rel={button.isEmail ? undefined : 'noopener noreferrer'}
        aria-label={button.label}
        data-share-button={button.icon}
      >
        <span class="social-share__icon" aria-hidden="true">
          {button.icon === 'twitter' && (
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
            </svg>
          )}
          {button.icon === 'facebook' && (
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
            </svg>
          )}
          {button.icon === 'linkedin' && (
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
            </svg>
          )}
          {button.icon === 'pinterest' && (
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z" />
            </svg>
          )}
          {button.icon === 'email' && (
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z" />
              <path d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z" />
            </svg>
          )}
        </span>
        {showLabels && <span class="social-share__text">{button.name}</span>}
      </a>
    ))}

    <!-- Copy Link Button -->
    <button
      type="button"
      class="social-share__button social-share__button--copy"
      data-copy-url={url}
      aria-label="Copy link to clipboard"
    >
      <span class="social-share__icon social-share__icon--copy" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M7.5 3.375c0-1.036.84-1.875 1.875-1.875h.375a3.75 3.75 0 013.75 3.75v1.875C13.5 8.161 14.34 9 15.375 9h1.875A3.75 3.75 0 0121 12.75v3.375C21 17.16 20.16 18 19.125 18h-9.75A1.875 1.875 0 017.5 16.125V3.375z" />
          <path d="M15 5.25a5.23 5.23 0 00-1.279-3.434 9.768 9.768 0 016.963 6.963A5.23 5.23 0 0017.25 7.5h-1.875A.375.375 0 0115 7.125V5.25zM4.875 6H6v10.125A3.375 3.375 0 009.375 19.5H16.5v1.125c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 013 20.625V7.875C3 6.839 3.84 6 4.875 6z" />
        </svg>
      </span>
      <span class="social-share__icon social-share__icon--copied" aria-hidden="true" style="display: none;">
        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" />
        </svg>
      </span>
      {showLabels && <span class="social-share__text">Copy Link</span>}
    </button>
  </div>
</div>

<style>
  .social-share {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
  }

  .social-share--vertical {
    flex-direction: column;
    align-items: flex-start;
  }

  .social-share__label {
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-tertiary);
  }

  .social-share__buttons {
    display: flex;
    gap: var(--spacing-2);
    flex-wrap: wrap;
  }

  .social-share--vertical .social-share__buttons {
    flex-direction: column;
  }

  .social-share__button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
    width: 40px;
    height: 40px;
    padding: 0;
    border: none;
    border-radius: var(--radius-full);
    background-color: var(--color-background-muted);
    color: var(--color-text-secondary);
    text-decoration: none;
    cursor: pointer;
    transition:
      background-color var(--duration-150) var(--ease-in-out),
      color var(--duration-150) var(--ease-in-out),
      transform var(--duration-150) var(--ease-out);
  }

  .social-share--with-labels .social-share__button {
    width: auto;
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: var(--radius-full);
  }

  .social-share__button:hover {
    transform: translateY(-2px);
  }

  .social-share__button:active {
    transform: translateY(0);
  }

  /* Platform-specific hover colors */
  .social-share__button--twitter:hover {
    background-color: #1DA1F2;
    color: white;
  }

  .social-share__button--facebook:hover {
    background-color: #1877F2;
    color: white;
  }

  .social-share__button--linkedin:hover {
    background-color: #0A66C2;
    color: white;
  }

  .social-share__button--pinterest:hover {
    background-color: #E60023;
    color: white;
  }

  .social-share__button--email:hover {
    background-color: var(--color-primary);
    color: white;
  }

  .social-share__button--copy:hover {
    background-color: var(--color-primary);
    color: white;
  }

  .social-share__button--copy.copied {
    background-color: #10B981;
    color: white;
  }

  .social-share__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
  }

  .social-share__icon svg {
    width: 100%;
    height: 100%;
  }

  .social-share__text {
    font-family: var(--font-body);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
  }

  /* Focus styles for accessibility */
  .social-share__button:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* Dark mode */
  :global(html[data-theme="dark"]) .social-share__button {
    background-color: var(--color-background-elevated);
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .social-share__button {
      transition: none;
    }

    .social-share__button:hover {
      transform: none;
    }
  }
</style>

<script>
  /**
   * Social Share Buttons - Client-side functionality
   * Handles copy-to-clipboard and analytics event tracking
   */

  // Track share event with Google Analytics
  function trackShareEvent(
    method: string,
    contentType: string,
    contentId: string,
    contentTitle: string
  ) {
    // Use GA4 gtag if available
    if (typeof window !== 'undefined' && (window as any).gtag) {
      (window as any).gtag('event', 'share', {
        method: method,
        content_type: contentType,
        item_id: contentId,
        content_id: contentId,
        content_title: contentTitle,
      });
    }

    // Also dispatch a custom event for any other analytics listeners
    document.dispatchEvent(
      new CustomEvent('social_share', {
        detail: {
          method,
          contentType,
          contentId,
          contentTitle,
        },
      })
    );
  }

  // Initialize share button tracking
  function initShareTracking() {
    // Track clicks on share buttons
    const shareButtons = document.querySelectorAll('[data-share-button]');

    shareButtons.forEach((button) => {
      button.addEventListener('click', (e) => {
        const platform = button.getAttribute('data-share-button');
        const container = button.closest('.social-share') as HTMLElement;

        if (platform && container) {
          const contentType = container.dataset.contentType || 'page';
          const contentId = container.dataset.contentId || '';
          const contentTitle = container.dataset.contentTitle || '';

          trackShareEvent(platform, contentType, contentId, contentTitle);
        }
      });
    });
  }

  // Copy to clipboard functionality with analytics tracking
  function initCopyToClipboard() {
    const copyButtons = document.querySelectorAll('[data-copy-url]');

    copyButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const url = button.getAttribute('data-copy-url');
        if (!url) return;

        // Get analytics data from container
        const container = button.closest('.social-share') as HTMLElement;
        const contentType = container?.dataset.contentType || 'page';
        const contentId = container?.dataset.contentId || '';
        const contentTitle = container?.dataset.contentTitle || '';

        try {
          await navigator.clipboard.writeText(url);

          // Track copy event
          trackShareEvent('copy_link', contentType, contentId, contentTitle);

          // Show success state
          button.classList.add('copied');
          const copyIcon = button.querySelector('.social-share__icon--copy') as HTMLElement;
          const copiedIcon = button.querySelector('.social-share__icon--copied') as HTMLElement;

          if (copyIcon && copiedIcon) {
            copyIcon.style.display = 'none';
            copiedIcon.style.display = 'flex';
          }

          // Update aria-label
          button.setAttribute('aria-label', 'Link copied!');

          // Reset after 2 seconds
          setTimeout(() => {
            button.classList.remove('copied');
            if (copyIcon && copiedIcon) {
              copyIcon.style.display = 'flex';
              copiedIcon.style.display = 'none';
            }
            button.setAttribute('aria-label', 'Copy link to clipboard');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = url;
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            // Track copy event even with fallback
            trackShareEvent('copy_link', contentType, contentId, contentTitle);
            button.classList.add('copied');
            setTimeout(() => button.classList.remove('copied'), 2000);
          } catch (e) {
            console.error('Fallback copy failed:', e);
          }
          document.body.removeChild(textArea);
        }
      });
    });
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    initShareTracking();
    initCopyToClipboard();
  });
</script>
